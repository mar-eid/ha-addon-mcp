#!/usr/bin/with-contenv bashio
# ==============================================================================
# Home Assistant Community Add-on: MCP Server
# ==============================================================================

# Read configuration
pg_host=$(bashio::config 'pg_host')
pg_port=$(bashio::config 'pg_port')
pg_database=$(bashio::config 'pg_database')
pg_user=$(bashio::config 'pg_user')
pg_password=$(bashio::config 'pg_password')
read_only=$(bashio::config 'read_only')
enable_timescaledb=$(bashio::config 'enable_timescaledb')

bashio::log.info "Starting MCP Server..."

# Export environment variables
export PGHOST="${pg_host}"
export PGPORT="${pg_port}"
export PGDATABASE="${pg_database}"
export PGUSER="${pg_user}"
export PGPASSWORD="${pg_password}"
export MCP_READ_ONLY="${read_only}"
export MCP_ENABLE_TIMESCALEDB="${enable_timescaledb}"
export MCP_PORT="8099"

bashio::log.info "Database: ${pg_user}@${pg_host}:${pg_port}/${pg_database}"

# Test database connection (quick test)
bashio::log.info "Testing database connection..."
if timeout 5 python3 -c "
import psycopg2
try:
    conn = psycopg2.connect(
        host='${pg_host}',
        port=${pg_port},
        database='${pg_database}',
        user='${pg_user}',
        password='${pg_password}',
        connect_timeout=3
    )
    conn.close()
    print('✅ Database OK')
except Exception as e:
    print(f'⚠️ Database failed: {e}')
" 2>&1; then
    bashio::log.info "Database test completed"
else
    bashio::log.warning "Database test failed - using mock data"
fi

bashio::log.info "Starting server on port ${MCP_PORT}..."

# Start the server
cd /app
exec python3 server.py